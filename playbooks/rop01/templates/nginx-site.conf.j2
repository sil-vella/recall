# Nginx configuration for {{ item.domain }}
# This is a basic template - customize as needed

{% if item.www_domain is defined %}
# Redirect www to non-www (or vice versa)
server {
    listen 80;
    listen [::]:80;
    server_name {{ item.www_domain }};

    # Let Certbot handle this during SSL setup
    location / {
        return 301 http://{{ item.domain }}$request_uri;
    }
}
{% endif %}

# Main server block
server {
    listen 80;
    listen [::]:80;
    server_name {{ item.domain }};

    # Root directory
    root {{ item.root_dir | default('/var/www/' + item.domain) }};
    index index.html index.htm;

    # Logging
    access_log /var/log/nginx/{{ item.domain }}.access.log;
    error_log /var/log/nginx/{{ item.domain }}.error.log;

    {% if item.backend_port is defined %}
    # Static sponsors directory for card back images and other sponsor content
    # Must come BEFORE location / to ensure it matches first
    location /sponsors/ {
        alias {{ item.root_dir | default('/var/www/' + item.domain) }}/sponsors/;
        autoindex off;
        expires 7d;
        add_header Cache-Control "public";
        # CORS headers for Flutter web image loading
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "*" always;
        # Handle OPTIONS preflight requests
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # Static sim_players/images directory for simulated player profile pictures
    # Must come BEFORE location / to ensure it matches first
    location /sim_players/ {
        alias {{ item.root_dir | default('/var/www/' + item.domain) }}/sim_players/;
        autoindex off;
        expires 7d;
        add_header Cache-Control "public";
        # CORS headers for Flutter web image loading
        add_header Access-Control-Allow-Origin "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header Access-Control-Allow-Headers "*" always;
        # Handle OPTIONS preflight requests
        if ($request_method = OPTIONS) {
            return 204;
        }
    }

    # Reverse proxy to backend application (e.g. Flask in Docker)
    location / {
        proxy_pass http://127.0.0.1:{{ item.backend_port }};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    {% if item.backend_ws_port is defined %}
    # WebSocket proxy to Dart game server
    location /ws {
        proxy_pass http://127.0.0.1:{{ item.backend_ws_port }};
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    {% endif %}
    {% else %}
    # Basic static-site location block
    location / {
        try_files $uri $uri/ =404;
    }
    {% endif %}

    # Static downloads directory for app binaries (e.g. APK/IPA)
    location /downloads/ {
        alias {{ item.root_dir | default('/var/www/' + item.domain) }}/downloads/;
        autoindex off;
        default_type application/octet-stream;
        add_header Content-Disposition "attachment";
    }

    # Security: deny access to hidden files
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    # If you need to serve static files (uncomment and adjust)
    # location /static/ {
    #     alias /var/www/{{ item.domain }}/static/;
    #     expires 30d;
    #     add_header Cache-Control "public, immutable";
    # }
}

# SSL configuration will be added automatically by Certbot
# After SSL setup, Certbot will modify this file to add:
# - listen 443 ssl;
# - SSL certificate paths
# - SSL redirect from HTTP to HTTPS
